<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RideFlow â€” Your Ride, Your Way</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../shared/theme.css">
</head>
<body>
<div class="bg-mesh"></div>

<!-- ===== LOADING SCREEN ===== -->
<div id="loadingScreen">
  <div class="loading-logo">
    <div class="logo-icon">ğŸ›µ</div>
    RideFlow
  </div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- ===== AUTH GATE ===== -->
<div id="authGate" style="display:none;">
  <div class="auth-gate-inner">
    <div class="auth-gate-logo">
      <div class="logo-icon">ğŸ›µ</div>
      RideFlow
    </div>
    <div class="auth-gate-sub">Your smart ride companion</div>
    <div class="auth-gate-card">
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      </div>

      <!-- Login form -->
      <div id="loginForm">
        <div class="form-group">
          <label class="form-label">EMAIL</label>
          <input class="form-input" id="loginEmail" type="email" placeholder="yourname@customer.mail">
        </div>
        <div class="form-error" id="loginError"></div>
        <button class="modal-btn" style="margin-top:6px;" onclick="doLogin()" id="loginBtn">
          Sign In
        </button>
        <div class="divider-or">or</div>
        <button class="modal-btn-outline" onclick="doGuestMode()">Continue as Guest</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== HEADER ===== -->
<header>
  <div class="logo" onclick="location.reload()">
    <div class="logo-icon">ğŸ›µ</div>
    RideFlow
  </div>
  <div class="header-right">
    <div class="header-status">
      <div class="status-dot"></div>
      <span>1,240 drivers nearby</span>
    </div>
    <!-- Shown when logged out -->
    <div id="headerAuthBtns">
      <button class="header-auth-btn btn-primary" onclick="showAuthGate()">Sign In</button>
    </div>
    <!-- Shown when logged in -->
    <div id="headerUser" style="display:none;">
      <div class="header-user" onclick="showUserMenu()">
        <div class="user-avatar-sm" id="headerAvatar">?</div>
        <div class="user-name-sm" id="headerName">User</div>
        <span style="color:var(--muted);font-size:11px;">â–¾</span>
      </div>
    </div>
  </div>
</header>

<!-- ===== APP SHELL ===== -->
<div id="appShell">
  <div class="main-grid">

    <!-- ===== LEFT: CHAT + HISTORY ===== -->
    <div class="chat-panel">
      <div class="chat-header">
        <div class="chat-title">Where are you<br>headed today?</div>
        <div class="chat-subtitle">Chat naturally â€” I'll set up your booking automatically.</div>
        <div class="chat-nav">
          <button class="chat-tab active" onclick="switchChatTab('chat')">ğŸ’¬ Chat</button>
          <button class="chat-tab" onclick="switchChatTab('history')">ğŸ“‹ History</button>
        </div>
      </div>

      <!-- Chat view -->
      <div class="chat-view active" id="chatView">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="typing-wrap">
          <div class="typing-indicator" id="typingIndicator">
            <div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-input-wrap">
            <textarea id="chatInput" rows="1"
              placeholder="e.g. 'Ride from Sudirman to Blok M by car'..."
              oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
            <button class="send-btn" onclick="sendMessage()">
              <svg width="14" height="14" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24">
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
              </svg>
            </button>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:6px;">
            <button onclick="deleteChatHistory()" style="font-size:11px;color:var(--muted);background:none;border:none;cursor:pointer;padding:2px 4px;" title="Delete chat history">ğŸ—‘ Clear chat</button>
          </div>
        </div>
      </div>

      <!-- History view -->
      <div class="history-view" id="historyView">
        <div id="historyList"></div>
        <div class="history-empty" id="historyEmpty" style="display:none;">
          <div class="history-empty-icon">ğŸ›µ</div>
          <p>No rides yet.<br>Book your first ride!</p>
        </div>
      </div>
    </div>

    <!-- ===== RIGHT: BOOKING PANEL ===== -->
    <div class="booking-panel">

      <!-- LOCATION -->
      <div>
        <div class="panel-label" style="margin-bottom:10px;">Location</div>
        <div class="location-card">
          <div class="loc-group">
            <div class="loc-dot pickup"></div>
            <div class="loc-line"></div>
            <input class="loc-input" id="pickupInput" placeholder="ğŸ“ Pickup location" type="text" autocomplete="off">
          </div>
          <div class="loc-group">
            <div class="loc-dot dest"></div>
            <input class="loc-input" id="destInput" placeholder="ğŸ¯ Where to?" type="text" autocomplete="off" style="padding-right:48px;">
            <button class="swap-btn" onclick="swapLocations()" title="Swap">
              <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                <path d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Saved location quick picks -->
        <div class="saved-picks" id="savedPicks" style="margin-top:9px;"></div>
      </div>

      <!-- PRICE ESTIMATOR -->
      <div class="price-strip" id="priceStrip">
        <div class="price-label">
          <span>ğŸ’°</span> Estimated Fare
        </div>
        <div style="text-align:right;">
          <div class="price-value" id="priceValue">â€”</div>
          <div class="price-sub" id="priceSub">Enter locations first</div>
        </div>
      </div>

      <!-- VEHICLE TYPE -->
      <div>
        <div class="panel-label" style="margin-bottom:10px;">Vehicle Type</div>
        <div class="vehicle-toggle">
          <button class="v-btn active" id="motoBtn" onclick="selectVehicle('motorcycle')">ğŸ Motorcycle</button>
          <button class="v-btn" id="carBtn" onclick="selectVehicle('car')">ğŸš— Car</button>
        </div>
      </div>

      <!-- SERVICE -->
      <div>
        <div class="panel-label" style="margin-bottom:10px;">Service</div>
        <div class="service-grid">
          <div class="svc-card active" id="svc-ride" onclick="selectService('ride')">
            <div class="svc-icon">ğŸ›µ</div>
            <div class="svc-name">Ride</div>
          </div>
          <div class="svc-card" id="svc-delivery" onclick="selectService('delivery')">
            <div class="svc-icon">ğŸ“¦</div>
            <div class="svc-name">Delivery</div>
          </div>
          <div class="svc-card" id="svc-food" onclick="selectService('food')">
            <div class="svc-icon">ğŸ±</div>
            <div class="svc-name">Food</div>
          </div>
        </div>
      </div>

      <!-- TIER / RATE SELECTION -->
      <div>
        <div class="sec-divider" style="margin-bottom:10px;">
          <div class="panel-label">Select Tier</div>
          <div class="sec-line"></div>
        </div>
        <div class="tier-list" id="tierList"></div>
      </div>

      <!-- SAVED LOCATIONS MANAGER -->
      <div>
        <div class="sec-divider" style="margin-bottom:10px;">
          <div class="panel-label">Saved Locations</div>
          <div class="sec-line"></div>
        </div>
        <div class="saved-loc-list" id="savedLocList"></div>
        <button class="add-saved-btn" onclick="openAddSavedModal()" style="margin-top:8px;">
          + Add Location
        </button>
      </div>

      <!-- BOOK BUTTON -->
      <button class="book-btn" id="bookBtn" onclick="openConfirmModal()">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24">
          <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        Find My Driver
      </button>

    </div>
  </div>
</div>

<!-- ===== MODAL: CONFIRM ORDER ===== -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-icon">ğŸš€</div>
    <div class="modal-title">Confirm Your Ride</div>
    <div class="modal-sub">Searching across Gojek &amp; Grab for the best driver</div>
    <div class="order-detail-block" id="confirmDetails"></div>
    <button class="modal-btn" onclick="proceedBook()">Confirm &amp; Find Driver</button>
    <button class="modal-btn-outline" onclick="closeModal('confirmModal')">Cancel</button>
  </div>
</div>

<!-- ===== MODAL: DRIVER FOUND ===== -->
<div class="modal-overlay" id="driverModal">
  <div class="modal">
    <div class="modal-title" style="margin-bottom:5px;">Driver Found! ğŸ‰</div>
    <div class="modal-sub" style="margin-bottom:16px;">Your driver is on the way</div>
    <div class="driver-card">
      <div class="driver-avatar">ğŸ‘¤</div>
      <div class="driver-info">
        <div class="driver-name" id="driverName">â€”</div>
        <div class="driver-sub" id="driverPlate">â€”</div>
        <div class="driver-stars" id="driverRating">â­ â€”</div>
      </div>
      <div class="eta-pill">
        <div class="eta-num" id="etaNum">â€”</div>
        <div class="eta-lbl">min away</div>
      </div>
    </div>
    <div class="prog-wrap">
      <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
      <div class="prog-steps">
        <span class="p-step done" id="ps1">âœ“ Confirmed</span>
        <span class="p-step" id="ps2">En Route</span>
        <span class="p-step" id="ps3">Arrived</span>
      </div>
    </div>
    <div class="order-detail-block" id="driverDetails"></div>
    <button class="modal-btn" onclick="completeRide()">Complete Ride</button>
    <button class="modal-btn-outline" onclick="cancelRide()">Cancel Ride</button>
  </div>
</div>

<!-- ===== MODAL: RATE DRIVER ===== -->
<div class="modal-overlay" id="ratingModal">
  <div class="modal">
    <div class="modal-icon">ğŸŒŸ</div>
    <div class="modal-title">Rate Your Driver</div>
    <div class="modal-sub" id="ratingDriverName">How was your ride?</div>
    <div class="star-row" id="starRow">
      <button class="star-btn" onclick="setRating(1)">â­</button>
      <button class="star-btn" onclick="setRating(2)">â­</button>
      <button class="star-btn" onclick="setRating(3)">â­</button>
      <button class="star-btn" onclick="setRating(4)">â­</button>
      <button class="star-btn" onclick="setRating(5)">â­</button>
    </div>
    <textarea class="review-textarea" id="reviewText" rows="3" placeholder="Any comments? (optional)"></textarea>
    <button class="modal-btn" style="margin-top:14px;" onclick="submitRating()">Submit Review</button>
    <button class="modal-btn-outline" onclick="closeModal('ratingModal'); addBotMessage('Thanks! Enjoy your next ride. ğŸ›µ')">Skip</button>
  </div>
</div>

<!-- ===== MODAL: ADD SAVED LOCATION ===== -->
<div class="modal-overlay" id="addSavedModal">
  <div class="modal">
    <div class="modal-title" style="margin-bottom:6px;">Save Location</div>
    <div class="modal-sub" style="margin-bottom:18px;">Quick access to your frequent spots</div>
    <div class="loc-type-grid" id="locTypeGrid">
      <button class="loc-type-btn active" onclick="selectLocType(this,'ğŸ ')" data-icon="ğŸ ">ğŸ <span>Home</span></button>
      <button class="loc-type-btn" onclick="selectLocType(this,'ğŸ¢')" data-icon="ğŸ¢">ğŸ¢<span>Office</span></button>
      <button class="loc-type-btn" onclick="selectLocType(this,'ğŸ«')" data-icon="ğŸ«">ğŸ«<span>Campus</span></button>
      <button class="loc-type-btn" onclick="selectLocType(this,'ğŸ“Œ')" data-icon="ğŸ“Œ">ğŸ“Œ<span>Other</span></button>
    </div>
    <div class="form-group">
      <label class="form-label">LABEL</label>
      <input class="form-input" id="savedLocLabel" type="text" placeholder="e.g. My Home, Office">
    </div>
    <div class="form-group">
      <label class="form-label">ADDRESS</label>
      <input class="form-input" id="savedLocAddr" type="text" placeholder="Full address or area name">
    </div>
    <button class="modal-btn" onclick="saveSavedLocation()">Save Location</button>
    <button class="modal-btn-outline" onclick="closeModal('addSavedModal')">Cancel</button>
  </div>
</div>

<!-- ===== MODAL: USER MENU ===== -->
<div class="modal-overlay" id="userMenuModal">
  <div class="modal" style="max-width:340px;">
    <div style="display:flex;align-items:center;gap:14px;margin-bottom:22px;">
      <div class="driver-avatar" id="menuAvatar" style="width:52px;height:52px;font-size:22px;flex-shrink:0;border-radius:50%;"></div>
      <div>
        <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:700;" id="menuName">â€”</div>
        <div style="font-size:12px;color:var(--text2);" id="menuEmail">â€”</div>
        <div style="font-size:11px;color:var(--accent);margin-top:3px;" id="menuGuest"></div>
      </div>
    </div>
    <div class="order-detail-block" id="menuStats"></div>
    <button class="modal-btn-danger" onclick="doSignOut()">Sign Out</button>
    <button class="modal-btn-outline" onclick="closeModal('userMenuModal')">Close</button>
  </div>
</div>

<!-- ===== TOAST ===== -->
<div class="toast" id="toast"><span id="toastMsg"></span></div>

<!-- ===== SCRIPTS ===== -->
<script src="../shared/constants.js"></script>
<script src="../shared/storage.js"></script>
<script src="../shared/api.js"></script>
<script src="../shared/auth.js"></script>
<script src="../shared/chat-sync.js"></script>
<script src="../shared/utils.js"></script>
<script src="app.js"></script>
</body>
</html>
