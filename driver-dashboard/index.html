<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RideFlow â€” Driver Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-sA+zWATbFtODh5UGaV9s1oqOuFsrpjDCEE/VJrDIi6U="
      crossorigin=""/>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="bg-mesh"></div>

<!-- ===== HEADER ===== -->
<header>
  <div class="logo">
    <div class="logo-icon">ğŸ›µ</div>
    RideFlow
    <span class="logo-badge">DRIVER</span>
  </div>

  <div class="header-center">
    <div class="status-toggle" id="statusToggle" onclick="toggleDriverStatus()">
      <div class="toggle-track on" id="toggleTrack">
        <div class="toggle-thumb"></div>
      </div>
      <span class="status-label online" id="statusLabel">Online</span>
    </div>
  </div>

  <div class="header-right">
    <div class="notif-btn" onclick="showToast('ğŸ“­ No new notifications')">
      <span>ğŸ””</span>
      <span class="notif-dot" id="notifDot"></span>
    </div>
    <div class="driver-avatar-sm" title="Driver Profile">ğŸ‘¨â€âœˆï¸</div>
    <a href="../customer-dashboard/" class="customer-app-link">
      Customer App
    </a>
  </div>
</header>

<!-- ===== APP SHELL ===== -->
<div id="appShell">
  <div class="dashboard-grid">

    <!-- ===== LEFT: MAP + ORDERS ===== -->
    <div class="left-panel">

      <!-- Live map (Leaflet) -->
      <div class="map-section">
        <div id="liveMap"></div>
        <div class="map-overlay-pills">
          <div class="map-pill">
            <div class="map-pill-dot"></div>
            <span id="mapStatusText">Searching for ordersâ€¦</span>
          </div>
          <div class="map-pill map-pill-stats">
            <span style="font-size:11px;color:var(--text2);">Today</span>
            <span id="mapTripCount" style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--accent);">0 trips</span>
          </div>
        </div>
        <div class="loc-status-bar" id="locStatusBar">
          <div class="loc-status-dot"></div>
          <span id="locStatusText">Requesting locationâ€¦</span>
        </div>
      </div>

      <!-- Incoming orders -->
      <div class="orders-section">
        <div class="section-header">
          <span class="section-title">Incoming Orders</span>
          <span class="section-badge" id="orderCountBadge">2 New</span>
        </div>
        <div class="orders-list" id="ordersList">
          <!-- Orders injected by app.js -->
        </div>
      </div>
    </div>

    <!-- ===== MIDDLE: MESSAGING ===== -->
    <div class="middle-panel">
      <div class="msg-panel-header">
        <div class="msg-panel-title">Messages</div>
        <div class="msg-panel-sub">Chat with your customer in real-time</div>
      </div>

      <!-- Active conversation header -->
      <div id="activeConvHeader" class="conv-header" style="display:none;">
        <div class="conv-avatar" id="convAvatar">A</div>
        <div class="conv-info">
          <div class="conv-name" id="convName">Customer</div>
          <div class="conv-status">
            <div class="online-dot"></div>
            <span>Online Â· Order #<span id="convOrderId">-</span></span>
          </div>
        </div>
        <div class="conv-actions">
          <span class="unread-badge-header" id="unreadBadgeHeader" style="display:none;">0</span>
          <button class="conv-action-btn" onclick="showToast('ğŸ“ Calling customerâ€¦')" title="Call">ğŸ“</button>
          <button class="conv-action-btn" onclick="showToast('â„¹ï¸ Order details')" title="Details">â„¹ï¸</button>
        </div>
      </div>

      <!-- No active order placeholder -->
      <div class="no-conv" id="noConvPlaceholder">
        <div class="no-conv-icon">ğŸ’¬</div>
        <p>Accept an order to<br>start chatting</p>
      </div>

      <!-- Chat messages -->
      <div class="chat-messages" id="chatMessages" style="display:none;"></div>

      <!-- Quick replies -->
      <div class="quick-replies" id="quickRepliesSection" style="display:none;">
        <div class="quick-replies-label">Quick Replies</div>
        <div class="quick-chips" id="quickChips">
          <button class="quick-chip" onclick="sendQuickReply('On my way! ğŸï¸')">On my way!</button>
          <button class="quick-chip" onclick="sendQuickReply('Arrived at pickup ğŸ“')">Arrived at pickup</button>
          <button class="quick-chip" onclick="sendQuickReply('5 minutes away â±ï¸')">5 min away</button>
          <button class="quick-chip" onclick="sendQuickReply('Heading to destination ğŸ—ºï¸')">To destination</button>
          <button class="quick-chip" onclick="sendQuickReply('Please wait a moment ğŸ™')">Please wait</button>
          <button class="quick-chip" onclick="sendQuickReply('Trip completed! Thank you ğŸ˜Š')">Trip completed!</button>
        </div>
      </div>

      <!-- Image preview strip (before send) -->
      <div class="img-preview-strip" id="imgPreviewStrip" style="display:none;"></div>

      <!-- Chat input -->
      <div class="chat-input-area" id="chatInputArea" style="display:none;">
        <div class="chat-input-wrap">
          <button class="img-upload-btn" id="imgUploadBtn" title="Send image"
                  onclick="document.getElementById('driverImgInput').click()">ğŸ“</button>
          <input type="file" id="driverImgInput"
                 accept="image/jpeg,image/png,image/gif,image/webp"
                 style="display:none;"
                 onchange="handleDriverImageSelect(event)">
          <textarea id="driverChatInput" placeholder="Type a messageâ€¦" rows="1"
            onkeydown="handleChatKey(event)"></textarea>
          <button class="send-btn" onclick="sendDriverMessage()">
            <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- ===== RIGHT: DRIVER INFO + EARNINGS ===== -->
    <div class="right-panel">

      <!-- Driver profile -->
      <div class="profile-section">
        <div class="earnings-title">Driver Profile</div>
        <div class="driver-profile-card">
          <div class="driver-avatar-lg">ğŸ‘¨â€âœˆï¸</div>
          <div class="driver-profile-info">
            <div class="driver-profile-name" id="driverName">Ahmad Rizky</div>
            <div class="driver-profile-sub" id="driverVehicle">Honda Beat Â· B 3312 XYZ</div>
            <div class="driver-profile-rating">
              â˜…â˜…â˜…â˜…â˜… <span style="color:var(--text2);font-size:11px;" id="driverRating">4.92</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Earnings -->
      <div class="earnings-section">
        <div class="earnings-title">Today's Earnings</div>
        <div class="earnings-main">
          <div class="earnings-label">Total Earnings</div>
          <div class="earnings-amount" id="totalEarnings">Rp 0</div>
          <div class="earnings-sub" id="earningsSub">Start accepting orders to earn</div>
        </div>
        <div class="earnings-grid">
          <div class="earnings-stat">
            <div class="stat-val trips" id="tripsCount">0</div>
            <div class="stat-label">Trips</div>
          </div>
          <div class="earnings-stat">
            <div class="stat-val rating" id="todayRating">4.9 â˜…</div>
            <div class="stat-label">Rating</div>
          </div>
          <div class="earnings-stat">
            <div class="stat-val online-time" id="onlineTime">0h 0m</div>
            <div class="stat-label">Online</div>
          </div>
        </div>
        <div class="commission-block" id="commissionBlock" style="display:none;">
          <div class="comm-row">
            <span class="comm-label">Gross Earnings</span>
            <span class="comm-val positive" id="grossEarnings">Rp 0</span>
          </div>
          <div class="comm-row">
            <span class="comm-label">Platform Fee (20%)</span>
            <span class="comm-val negative" id="platformFee">- Rp 0</span>
          </div>
          <div class="comm-row" style="border-top: 1px solid var(--border2);">
            <span class="comm-label" style="font-weight:600;color:var(--text);">Net Earnings</span>
            <span class="comm-val positive" style="font-size:14px;" id="netEarnings">Rp 0</span>
          </div>
        </div>
      </div>

      <!-- Active order information -->
      <div class="active-info-section">
        <div class="active-info-title">Active Order</div>
        <div id="noActiveOrderMsg" class="no-active-order">
          No active order. Accept an incoming order to get started.
        </div>
        <div id="activeOrderInfo" style="display:none;">
          <div class="customer-info-card">
            <div class="conv-avatar" id="activeCustomerAvatar" style="width:42px;height:42px;font-size:16px;">A</div>
            <div class="customer-detail-info">
              <div class="customer-detail-name" id="activeCustomerName">â€”</div>
              <div class="customer-detail-meta">
                <span class="cust-rating" id="activeCustomerRating">â˜… â€”</span>
                <span id="activeCustomerPhone">â€”</span>
              </div>
            </div>
            <button class="call-btn" onclick="showToast('ğŸ“ Calling customerâ€¦')">ğŸ“</button>
          </div>
          <div class="route-detail-card">
            <div class="route-detail-row">
              <div class="route-detail-icon pickup">ğŸ“</div>
              <div class="route-detail-text">
                <div class="route-detail-label">Pickup Location</div>
                <div class="route-detail-addr" id="activePickup">â€”</div>
              </div>
            </div>
            <div style="width:1px;height:14px;background:linear-gradient(var(--accent),var(--accent3));margin:4px 0 4px 13px;opacity:0.3;"></div>
            <div class="route-detail-row">
              <div class="route-detail-icon dest">ğŸ</div>
              <div class="route-detail-text">
                <div class="route-detail-label">Destination</div>
                <div class="route-detail-addr" id="activeDest">â€”</div>
              </div>
            </div>
          </div>
          <div class="service-type-card">
            <div class="service-type-left">
              <div class="service-type-icon" id="activeServiceIcon">ğŸ›µ</div>
              <div>
                <div class="service-type-name" id="activeServiceName">Motorcycle</div>
                <div class="service-type-tier" id="activeServiceTier">Standard</div>
              </div>
            </div>
            <div class="service-type-price" id="activeServicePrice">Rp 0</div>
          </div>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="action-section" id="actionSection" style="display:none;">
        <button class="action-btn-primary" id="primaryActionBtn" onclick="handlePrimaryAction()">
          <span id="primaryActionIcon">ğŸš€</span>
          <span id="primaryActionText">Navigate to Pickup</span>
        </button>
        <button class="action-btn-secondary" onclick="completeTrip()">
          âœ… Mark as Completed
        </button>
      </div>

      <!-- Performance metrics -->
      <div class="performance-section">
        <div class="perf-title">Performance</div>
        <div class="perf-grid">
          <div class="perf-card">
            <div class="perf-icon">âœ…</div>
            <div class="perf-val" style="color:var(--accent);" id="acceptRate">95%</div>
            <div class="perf-label">Accept Rate</div>
          </div>
          <div class="perf-card">
            <div class="perf-icon">âš¡</div>
            <div class="perf-val" style="color:var(--accent2);" id="avgResponse">1.2s</div>
            <div class="perf-label">Avg Response</div>
          </div>
          <div class="perf-card">
            <div class="perf-icon">ğŸ¯</div>
            <div class="perf-val" style="color:var(--accent3);" id="completionRate">98%</div>
            <div class="perf-label">Completion</div>
          </div>
          <div class="perf-card">
            <div class="perf-icon">ğŸ“…</div>
            <div class="perf-val" style="color:var(--text);" id="totalTripsAllTime">247</div>
            <div class="perf-label">All-Time Trips</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <span id="toastMsg">âœ… Done</span>
</div>

<!-- ===== SCRIPTS ===== -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+X/ibW7URpOYYaFs="
        crossorigin=""></script>
<script src="../shared/constants.js"></script>
<script src="../shared/storage.js"></script>
<script src="../shared/chat-sync.js"></script>
<script src="../shared/api.js"></script>
<script src="app.js"></script>
</body>
</html>
